<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„±ê²½ ì½ê¸° ìŠ¤ì¼€ì¤„ëŸ¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .nav {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .nav-btn {
      flex: 1;
      padding: 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6c757d;
      transition: all 0.3s;
      position: relative;
    }

    .nav-btn.active {
      color: #667eea;
    }

    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: #667eea;
    }

    .content {
      padding: 20px;
      min-height: 400px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-group input[type="date"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 14px;
      transition: border 0.3s;
    }

    .form-group input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .weekday-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .weekday-btn {
      flex: 1;
      min-width: 45px;
      padding: 10px;
      border: 2px solid #e9ecef;
      background: white;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #6c757d;
      transition: all 0.3s;
    }

    .weekday-btn.selected {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .btn-primary {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      padding: 8px 16px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .testament-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .testament-tab {
      flex: 1;
      padding: 10px;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      font-weight: 500;
      transition: all 0.3s;
    }

    .testament-tab.active {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .book-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .book-item {
      position: relative;
    }

    .book-checkbox {
      display: none;
    }

    .book-label {
      display: block;
      padding: 10px 5px;
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .book-checkbox:checked + .book-label {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .schedule-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #e9ecef;
    }

    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .schedule-name {
      font-weight: 600;
      font-size: 16px;
      color: #333;
    }

    .schedule-actions {
      display: flex;
      gap: 5px;
    }

    .icon-btn {
      padding: 5px 10px;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .schedule-progress {
      margin-top: 10px;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }

    .schedule-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }

    .reading-view {
      padding: 20px;
    }

    .chapter-content {
      line-height: 1.8;
      color: #333;
      margin-bottom: 20px;
    }

    .verse {
      margin-bottom: 12px;
      display: flex;
      gap: 10px;
    }

    .verse-number {
      color: #667eea;
      font-weight: 600;
      min-width: 30px;
    }

    .verse-text {
      flex: 1;
    }

    .verse-title {
      font-weight: 600;
      color: #764ba2;
      margin-bottom: 5px;
    }

    .bookmark-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.3;
      transition: opacity 0.3s;
    }

    .bookmark-btn.bookmarked {
      opacity: 1;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 20px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .exclude-calendar {
      margin-top: 15px;
    }

    .calendar-month {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .calendar-month-header {
      font-weight: 600;
      font-size: 16px;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 5px;
    }

    .calendar-weekday {
      padding: 5px;
      text-align: center;
      font-size: 11px;
      color: #6c757d;
      font-weight: 600;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .calendar-day {
      padding: 10px;
      text-align: center;
      border: 1px solid #e9ecef;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      background: white;
      transition: all 0.2s;
    }

    .calendar-day:hover {
      background: #f8f9fa;
    }

    .calendar-day.selected {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .calendar-day.disabled {
      opacity: 0.3;
      cursor: not-allowed;
      background: #f8f9fa;
    }

    .calendar-day.other-month {
      opacity: 0.3;
      cursor: default;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .chapter-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    .chapter-nav select {
      flex: 1;
      padding: 10px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 14px;
    }

    .nav-arrow {
      width: 40px;
      height: 40px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .nav-arrow:hover {
      background: #5568d3;
    }

    .nav-arrow:active {
      transform: scale(0.95);
    }

    .progress-day {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 2px solid #e9ecef;
    }

    .progress-day.completed {
      border-color: #28a745;
      background: #f1f9f3;
    }

    .progress-day.missed {
      border-color: #dc3545;
      background: #fef1f2;
    }

    .progress-day.upcoming {
      border-color: #6c757d;
      background: #f8f9fa;
    }

    .progress-day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .progress-date {
      font-weight: 600;
      font-size: 15px;
    }

    .progress-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .progress-status.completed {
      background: #28a745;
      color: white;
    }

    .progress-status.missed {
      background: #dc3545;
      color: white;
    }

    .progress-status.upcoming {
      background: #6c757d;
      color: white;
    }

    .progress-chapters {
      font-size: 13px;
      color: #495057;
      line-height: 1.6;
    }

    .read-check {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: center;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“– ì„±ê²½ ì½ê¸°</h1>
      <p>ë§ì”€ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í•˜ë£¨</p>
    </div>

    <div class="nav">
      <button class="nav-btn active" onclick="showSection('schedule')">ìŠ¤ì¼€ì¤„</button>
      <button class="nav-btn" onclick="showSection('read')">ì½ê¸°</button>
      <button class="nav-btn" onclick="showSection('progress')">ì§„í–‰ìƒí™©</button>
      <button class="nav-btn" onclick="showSection('bookmark')">ë¶ë§ˆí¬</button>
    </div>

    <div class="content">
      <!-- ìŠ¤ì¼€ì¤„ ì„¹ì…˜ -->
      <div id="schedule" class="section active">
        <div class="form-group">
          <label>ì‹œì‘ ë‚ ì§œ</label>
          <input type="date" id="startDate">
        </div>

        <div class="form-group">
          <label>ì¢…ë£Œ ë‚ ì§œ</label>
          <input type="date" id="endDate">
        </div>

        <div class="form-group">
          <label>ì½ê¸° ìš”ì¼</label>
          <div class="weekday-selector">
            <button class="weekday-btn" data-day="0">ì¼</button>
            <button class="weekday-btn selected" data-day="1">ì›”</button>
            <button class="weekday-btn selected" data-day="2">í™”</button>
            <button class="weekday-btn selected" data-day="3">ìˆ˜</button>
            <button class="weekday-btn selected" data-day="4">ëª©</button>
            <button class="weekday-btn selected" data-day="5">ê¸ˆ</button>
            <button class="weekday-btn" data-day="6">í† </button>
          </div>
        </div>

        <div class="form-group">
          <label>ì œì™¸í•  ë‚ ì§œ</label>
          <button class="btn-secondary" onclick="openExcludeDateModal()">ë‚ ì§œ ì„ íƒ</button>
          <div id="excludedDatesDisplay"></div>
        </div>

        <div class="form-group">
          <label>ì½ì„ ì„±ê²½</label>
          <div class="testament-tabs">
            <div class="testament-tab" onclick="selectTestament('ot')">êµ¬ì•½</div>
            <div class="testament-tab" onclick="selectTestament('nt')">ì‹ ì•½</div>
            <div class="testament-tab active" onclick="selectTestament('custom')">ì§ì ‘ ì„ íƒ</div>
          </div>
          <div id="customBooks" style="display: block;">
            <button class="btn-secondary" onclick="selectAllBooks('ot')">êµ¬ì•½ ì „ì²´</button>
            <button class="btn-secondary" onclick="selectAllBooks('nt')">ì‹ ì•½ ì „ì²´</button>
            <div class="book-grid" id="bookGrid"></div>
          </div>
        </div>

        <button class="btn-primary" onclick="createSchedule()">ìŠ¤ì¼€ì¤„ ìƒì„±</button>

        <div style="margin-top: 30px;">
          <h3 style="margin-bottom: 15px;">ë‚´ ìŠ¤ì¼€ì¤„</h3>
          <div id="scheduleList" class="schedule-list"></div>
        </div>
      </div>

      <!-- ì½ê¸° ì„¹ì…˜ -->
      <div id="read" class="section">
        <div id="scheduleSelector" style="margin-bottom: 20px;"></div>
        <div class="chapter-nav">
          <button class="nav-arrow" onclick="prevChapter()">â—€</button>
          <select id="bookSelect" onchange="loadChapters()"></select>
          <select id="chapterSelect" onchange="loadChapter()"></select>
          <button class="nav-arrow" onclick="nextChapter()">â–¶</button>
        </div>
        <div id="readingContent"></div>
      </div>

      <!-- ì§„í–‰ìƒí™© ì„¹ì…˜ -->
      <div id="progress" class="section">
        <div id="progressScheduleSelector" style="margin-bottom: 20px;"></div>
        <div id="progressCalendar"></div>
      </div>

      <!-- ë¶ë§ˆí¬ ì„¹ì…˜ -->
      <div id="bookmark" class="section">
        <div id="bookmarkList"></div>
      </div>
    </div>
  </div>

  <!-- ë‚ ì§œ ì œì™¸ ëª¨ë‹¬ -->
  <div id="excludeDateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ì œì™¸í•  ë‚ ì§œ ì„ íƒ</div>
      <div id="excludeCalendar" class="exclude-calendar"></div>
      <button class="btn-primary" style="margin-top: 20px;" onclick="closeExcludeDateModal()">í™•ì¸</button>
    </div>
  </div>

  <script>
    let booksData = [];
    let schedules = [];
    let currentSchedule = null;
    let excludedDates = [];
    let selectedDays = [1, 2, 3, 4, 5];
    let bookmarks = [];
    let currentBook = null;
    let currentChapter = 1;

    // ì´ˆê¸°í™”
    async function init() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').value = today;
      document.getElementById('endDate').value = today;

      await loadBooksData();
      loadFromStorage();
      renderBookGrid();
      renderScheduleList();
      setupWeekdaySelector();
      checkMidnightReschedule();
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ
    function loadFromStorage() {
      const stored = localStorage.getItem('bibleSchedules');
      if (stored) schedules = JSON.parse(stored);
      
      const storedBookmarks = localStorage.getItem('bibleBookmarks');
      if (storedBookmarks) bookmarks = JSON.parse(storedBookmarks);
      
      const storedExcluded = localStorage.getItem('excludedDates');
      if (storedExcluded) excludedDates = JSON.parse(storedExcluded);
    }

    // ë°ì´í„° ì €ì¥
    function saveToStorage() {
      localStorage.setItem('bibleSchedules', JSON.stringify(schedules));
      localStorage.setItem('bibleBookmarks', JSON.stringify(bookmarks));
      localStorage.setItem('excludedDates', JSON.stringify(excludedDates));
    }

    // books.json ë¡œë“œ
    async function loadBooksData() {
      try {
        const response = await fetch('books.json');
        if (!response.ok) {
          throw new Error('books.json íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        const data = await response.json();
        booksData = data.books;
      } catch (error) {
        console.error('books.json ë¡œë“œ ì‹¤íŒ¨:', error);
        // íŒŒì¼ì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ ë°ì´í„° ì‚¬ìš© (66ê¶Œ ì „ì²´)
        booksData = [
          // êµ¬ì•½ (39ê¶Œ)
          { name: "ì°½ì„¸ê¸°", abbr: "ì°½", testament: "ot", file: "bible/1-01ì°½ì„¸ê¸°.txt", chapters: 50 },
          { name: "ì¶œì• êµ½ê¸°", abbr: "ì¶œ", testament: "ot", file: "bible/1-02ì¶œì• êµ½ê¸°.txt", chapters: 40 },
          { name: "ë ˆìœ„ê¸°", abbr: "ë ˆ", testament: "ot", file: "bible/1-03ë ˆìœ„ê¸°.txt", chapters: 27 },
          { name: "ë¯¼ìˆ˜ê¸°", abbr: "ë¯¼", testament: "ot", file: "bible/1-04ë¯¼ìˆ˜ê¸°.txt", chapters: 36 },
          { name: "ì‹ ëª…ê¸°", abbr: "ì‹ ", testament: "ot", file: "bible/1-05ì‹ ëª…ê¸°.txt", chapters: 34 },
          { name: "ì—¬í˜¸ìˆ˜ì•„", abbr: "ìˆ˜", testament: "ot", file: "bible/1-06ì—¬í˜¸ìˆ˜ì•„.txt", chapters: 24 },
          { name: "ì‚¬ì‚¬ê¸°", abbr: "ì‚¿", testament: "ot", file: "bible/1-07ì‚¬ì‚¬ê¸°.txt", chapters: 21 },
          { name: "ë£»ê¸°", abbr: "ë£»", testament: "ot", file: "bible/1-08ë£»ê¸°.txt", chapters: 4 },
          { name: "ì‚¬ë¬´ì—˜ìƒ", abbr: "ì‚¼ìƒ", testament: "ot", file: "bible/1-09ì‚¬ë¬´ì—˜ìƒ.txt", chapters: 31 },
          { name: "ì‚¬ë¬´ì—˜í•˜", abbr: "ì‚¼í•˜", testament: "ot", file: "bible/1-10ì‚¬ë¬´ì—˜í•˜.txt", chapters: 24 },
          { name: "ì—´ì™•ê¸°ìƒ", abbr: "ì™•ìƒ", testament: "ot", file: "bible/1-11ì—´ì™•ê¸°ìƒ.txt", chapters: 22 },
          { name: "ì—´ì™•ê¸°í•˜", abbr: "ì™•í•˜", testament: "ot", file: "bible/1-12ì—´ì™•ê¸°í•˜.txt", chapters: 25 },
          { name: "ì—­ëŒ€ìƒ", abbr: "ëŒ€ìƒ", testament: "ot", file: "bible/1-13ì—­ëŒ€ìƒ.txt", chapters: 29 },
          { name: "ì—­ëŒ€í•˜", abbr: "ëŒ€í•˜", testament: "ot", file: "bible/1-14ì—­ëŒ€í•˜.txt", chapters: 36 },
          { name: "ì—ìŠ¤ë¼", abbr: "ìŠ¤", testament: "ot", file: "bible/1-15ì—ìŠ¤ë¼.txt", chapters: 10 },
          { name: "ëŠí—¤ë¯¸ì•¼", abbr: "ëŠ", testament: "ot", file: "bible/1-16ëŠí—¤ë¯¸ì•¼.txt", chapters: 13 },
          { name: "ì—ìŠ¤ë”", abbr: "ì—", testament: "ot", file: "bible/1-17ì—ìŠ¤ë”.txt", chapters: 10 },
          { name: "ìš¥ê¸°", abbr: "ìš¥", testament: "ot", file: "bible/1-18ìš¥ê¸°.txt", chapters: 42 },
          { name: "ì‹œí¸", abbr: "ì‹œ", testament: "ot", file: "bible/1-19ì‹œí¸.txt", chapters: 150 },
          { name: "ì ì–¸", abbr: "ì ", testament: "ot", file: "bible/1-20ì ì–¸.txt", chapters: 31 },
          { name: "ì „ë„ì„œ", abbr: "ì „", testament: "ot", file: "bible/1-21ì „ë„ì„œ.txt", chapters: 12 },
          { name: "ì•„ê°€", abbr: "ì•„", testament: "ot", file: "bible/1-22ì•„ê°€.txt", chapters: 8 },
          { name: "ì´ì‚¬ì•¼", abbr: "ì‚¬", testament: "ot", file: "bible/1-23ì´ì‚¬ì•¼.txt", chapters: 66 },
          { name: "ì˜ˆë ˆë¯¸ì•¼", abbr: "ë ˜", testament: "ot", file: "bible/1-24ì˜ˆë ˆë¯¸ì•¼.txt", chapters: 52 },
          { name: "ì˜ˆë ˆë¯¸ì•¼ì• ê°€", abbr: "ì• ", testament: "ot", file: "bible/1-25ì˜ˆë ˆë¯¸ì•¼ì• ê°€.txt", chapters: 5 },
          { name: "ì—ìŠ¤ê²”", abbr: "ê²”", testament: "ot", file: "bible/1-26ì—ìŠ¤ê²”.txt", chapters: 48 },
          { name: "ë‹¤ë‹ˆì—˜", abbr: "ë‹¨", testament: "ot", file: "bible/1-27ë‹¤ë‹ˆì—˜.txt", chapters: 12 },
          { name: "í˜¸ì„¸ì•„", abbr: "í˜¸", testament: "ot", file: "bible/1-28í˜¸ì„¸ì•„.txt", chapters: 14 },
          { name: "ìš”ì—˜", abbr: "ìšœ", testament: "ot", file: "bible/1-29ìš”ì—˜.txt", chapters: 3 },
          { name: "ì•„ëª¨ìŠ¤", abbr: "ì•”", testament: "ot", file: "bible/1-30ì•„ëª¨ìŠ¤.txt", chapters: 9 },
          { name: "ì˜¤ë°”ëŒœ", abbr: "ì˜µ", testament: "ot", file: "bible/1-31ì˜¤ë°”ëŒœ.txt", chapters: 1 },
          { name: "ìš”ë‚˜", abbr: "ìš˜", testament: "ot", file: "bible/1-32ìš”ë‚˜.txt", chapters: 4 },
          { name: "ë¯¸ê°€", abbr: "ë¯¸", testament: "ot", file: "bible/1-33ë¯¸ê°€.txt", chapters: 7 },
          { name: "ë‚˜í›”", abbr: "ë‚˜", testament: "ot", file: "bible/1-34ë‚˜í›”.txt", chapters: 3 },
          { name: "í•˜ë°•êµ­", abbr: "í•©", testament: "ot", file: "bible/1-35í•˜ë°•êµ­.txt", chapters: 3 },
          { name: "ìŠ¤ë°”ëƒ", abbr: "ìŠµ", testament: "ot", file: "bible/1-36ìŠ¤ë°”ëƒ.txt", chapters: 3 },
          { name: "í•™ê°œ", abbr: "í•™", testament: "ot", file: "bible/1-37í•™ê°œ.txt", chapters: 2 },
          { name: "ìŠ¤ê°€ë´", abbr: "ìŠ¥", testament: "ot", file: "bible/1-38ìŠ¤ê°€ë´.txt", chapters: 14 },
          { name: "ë§ë¼ê¸°", abbr: "ë§", testament: "ot", file: "bible/1-39ë§ë¼ê¸°.txt", chapters: 4 },
          
          // ì‹ ì•½ (27ê¶Œ)
          { name: "ë§ˆíƒœë³µìŒ", abbr: "ë§ˆ", testament: "nt", file: "bible/2-01ë§ˆíƒœë³µìŒ.txt", chapters: 28 },
          { name: "ë§ˆê°€ë³µìŒ", abbr: "ë§‰", testament: "nt", file: "bible/2-02ë§ˆê°€ë³µìŒ.txt", chapters: 16 },
          { name: "ëˆ„ê°€ë³µìŒ", abbr: "ëˆ…", testament: "nt", file: "bible/2-03ëˆ„ê°€ë³µìŒ.txt", chapters: 24 },
          { name: "ìš”í•œë³µìŒ", abbr: "ìš”", testament: "nt", file: "bible/2-04ìš”í•œë³µìŒ.txt", chapters: 21 },
          { name: "ì‚¬ë„í–‰ì „", abbr: "í–‰", testament: "nt", file: "bible/2-05ì‚¬ë„í–‰ì „.txt", chapters: 28 },
          { name: "ë¡œë§ˆì„œ", abbr: "ë¡¬", testament: "nt", file: "bible/2-06ë¡œë§ˆì„œ.txt", chapters: 16 },
          { name: "ê³ ë¦°ë„ì „ì„œ", abbr: "ê³ ì „", testament: "nt", file: "bible/2-07ê³ ë¦°ë„ì „ì„œ.txt", chapters: 16 },
          { name: "ê³ ë¦°ë„í›„ì„œ", abbr: "ê³ í›„", testament: "nt", file: "bible/2-08ê³ ë¦°ë„í›„ì„œ.txt", chapters: 13 },
          { name: "ê°ˆë¼ë””ì•„ì„œ", abbr: "ê°ˆ", testament: "nt", file: "bible/2-09ê°ˆë¼ë””ì•„ì„œ.txt", chapters: 6 },
          { name: "ì—ë² ì†Œì„œ", abbr: "ì—¡", testament: "nt", file: "bible/2-10ì—ë² ì†Œì„œ.txt", chapters: 6 },
          { name: "ë¹Œë¦½ë³´ì„œ", abbr: "ë¹Œ", testament: "nt", file: "bible/2-11ë¹Œë¦½ë³´ì„œ.txt", chapters: 4 },
          { name: "ê³¨ë¡œìƒˆì„œ", abbr: "ê³¨", testament: "nt", file: "bible/2-12ê³¨ë¡œìƒˆì„œ.txt", chapters: 4 },
          { name: "ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ", abbr: "ì‚´ì „", testament: "nt", file: "bible/2-13ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ.txt", chapters: 5 },
          { name: "ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ", abbr: "ì‚´í›„", testament: "nt", file: "bible/2-14ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ.txt", chapters: 3 },
          { name: "ë””ëª¨ë°ì „ì„œ", abbr: "ë”¤ì „", testament: "nt", file: "bible/2-15ë””ëª¨ë°ì „ì„œ.txt", chapters: 6 },
          { name: "ë””ëª¨ë°í›„ì„œ", abbr: "ë”¤í›„", testament: "nt", file: "bible/2-16ë””ëª¨ë°í›„ì„œ.txt", chapters: 4 },
          { name: "ë””ë„ì„œ", abbr: "ë”›", testament: "nt", file: "bible/2-17ë””ë„ì„œ.txt", chapters: 3 },
          { name: "ë¹Œë ˆëª¬ì„œ", abbr: "ëª¬", testament: "nt", file: "bible/2-18ë¹Œë ˆëª¬ì„œ.txt", chapters: 1 },
          { name: "íˆë¸Œë¦¬ì„œ", abbr: "íˆ", testament: "nt", file: "bible/2-19íˆë¸Œë¦¬ì„œ.txt", chapters: 13 },
          { name: "ì•¼ê³ ë³´ì„œ", abbr: "ì•½", testament: "nt", file: "bible/2-20ì•¼ê³ ë³´ì„œ.txt", chapters: 5 },
          { name: "ë² ë“œë¡œì „ì„œ", abbr: "ë²§ì „", testament: "nt", file: "bible/2-21ë² ë“œë¡œì „ì„œ.txt", chapters: 5 },
          { name: "ë² ë“œë¡œí›„ì„œ", abbr: "ë²§í›„", testament: "nt", file: "bible/2-22ë² ë“œë¡œí›„ì„œ.txt", chapters: 3 },
          { name: "ìš”í•œ1ì„œ", abbr: "ìš”ì¼", testament: "nt", file: "bible/2-23ìš”í•œ1ì„œ.txt", chapters: 5 },
          { name: "ìš”í•œ2ì„œ", abbr: "ìš”ì´", testament: "nt", file: "bible/2-24ìš”í•œ2ì„œ.txt", chapters: 1 },
          { name: "ìš”í•œ3ì„œ", abbr: "ìš”ì‚¼", testament: "nt", file: "bible/2-25ìš”í•œ3ì„œ.txt", chapters: 1 },
          { name: "ìœ ë‹¤ì„œ", abbr: "ìœ ", testament: "nt", file: "bible/2-26ìœ ë‹¤ì„œ.txt", chapters: 1 },
          { name: "ìš”í•œê³„ì‹œë¡", abbr: "ê³„", testament: "nt", file: "bible/2-27ìš”í•œê³„ì‹œë¡.txt", chapters: 22 }
        ];
      }
    }

    // ì±… ê·¸ë¦¬ë“œ ë Œë”ë§
    function renderBookGrid() {
      const grid = document.getElementById('bookGrid');
      grid.innerHTML = booksData.map((book, idx) => `
        <div class="book-item">
          <input type="checkbox" id="book${idx}" class="book-checkbox" data-testament="${book.testament}">
          <label for="book${idx}" class="book-label">${book.name}</label>
        </div>
      `).join('');
    }

    // ì„¹ì…˜ í‘œì‹œ
    function showSection(section) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      
      document.getElementById(section).classList.add('active');
      event.target.classList.add('active');

      if (section === 'read') {
        renderScheduleSelector();
        loadBookList();
      } else if (section === 'bookmark') {
        renderBookmarks();
      } else if (section === 'progress') {
        renderProgressScheduleSelector();
        renderProgressCalendar();
      }
    }

    // ìš”ì¼ ì„ íƒ
    function setupWeekdaySelector() {
      document.querySelectorAll('.weekday-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('selected');
          const day = parseInt(this.dataset.day);
          const idx = selectedDays.indexOf(day);
          if (idx > -1) {
            selectedDays.splice(idx, 1);
          } else {
            selectedDays.push(day);
          }
        });
      });
    }

    // ì„±ê²½ ì„ íƒ ëª¨ë“œ
    function selectTestament(type) {
      document.querySelectorAll('.testament-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.querySelectorAll('.book-checkbox').forEach(cb => cb.checked = false);
      
      if (type === 'ot' || type === 'nt') {
        document.querySelectorAll(`.book-checkbox[data-testament="${type}"]`).forEach(cb => cb.checked = true);
      }
    }

    // ì „ì²´ ì„ íƒ
    function selectAllBooks(testament) {
      document.querySelectorAll(`.book-checkbox[data-testament="${testament}"]`).forEach(cb => {
        cb.checked = true;
      });
    }

    // ë‚ ì§œ ì œì™¸ ëª¨ë‹¬
    function openExcludeDateModal() {
      const modal = document.getElementById('excludeDateModal');
      modal.classList.add('active');
      renderExcludeCalendar();
    }

    function closeExcludeDateModal() {
      document.getElementById('excludeDateModal').classList.remove('active');
      renderExcludedDates();
    }

    function renderExcludeCalendar() {
      const calendar = document.getElementById('excludeCalendar');
      const start = new Date(document.getElementById('startDate').value);
      const end = new Date(document.getElementById('endDate').value);
      
      calendar.innerHTML = '';
      
      // ì‹œì‘ì›”ë¶€í„° ì¢…ë£Œì›”ê¹Œì§€ ë°˜ë³µ
      let currentDate = new Date(start.getFullYear(), start.getMonth(), 1);
      const endMonth = new Date(end.getFullYear(), end.getMonth(), 1);
      
      while (currentDate <= endMonth) {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // ì›” ì»¨í…Œì´ë„ˆ ìƒì„±
        const monthDiv = document.createElement('div');
        monthDiv.className = 'calendar-month';
        
        // ì›” í—¤ë”
        const monthHeader = document.createElement('div');
        monthHeader.className = 'calendar-month-header';
        monthHeader.textContent = `${year}ë…„ ${month + 1}ì›”`;
        monthDiv.appendChild(monthHeader);
        
        // ìš”ì¼ í—¤ë”
        const weekdaysDiv = document.createElement('div');
        weekdaysDiv.className = 'calendar-weekdays';
        ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
          const dayDiv = document.createElement('div');
          dayDiv.className = 'calendar-weekday';
          dayDiv.textContent = day;
          weekdaysDiv.appendChild(dayDiv);
        });
        monthDiv.appendChild(weekdaysDiv);
        
        // ë‚ ì§œ ê·¸ë¦¬ë“œ
        const daysDiv = document.createElement('div');
        daysDiv.className = 'calendar-days';
        
        // ì²« ë‚ ì˜ ìš”ì¼ êµ¬í•˜ê¸°
        const firstDay = new Date(year, month, 1).getDay();
        
        // ì´ì „ ë‹¬ì˜ ë¹ˆ ì¹¸
        for (let i = 0; i < firstDay; i++) {
          const emptyDiv = document.createElement('div');
          emptyDiv.className = 'calendar-day other-month';
          daysDiv.appendChild(emptyDiv);
        }
        
        // í˜„ì¬ ë‹¬ì˜ ë‚ ì§œë“¤
        const lastDate = new Date(year, month + 1, 0).getDate();
        for (let day = 1; day <= lastDate; day++) {
          const dateObj = new Date(year, month, day);
          const dateStr = dateObj.toISOString().split('T')[0];
          
          const dayDiv = document.createElement('div');
          dayDiv.className = 'calendar-day';
          dayDiv.textContent = day;
          
          // ë²”ìœ„ ë‚´ ë‚ ì§œë§Œ ì„ íƒ ê°€ëŠ¥
          if (dateObj >= start && dateObj <= end) {
            const isExcluded = excludedDates.includes(dateStr);
            if (isExcluded) {
              dayDiv.classList.add('selected');
            }
            dayDiv.onclick = () => toggleExcludeDate(dateStr, dayDiv);
          } else {
            dayDiv.classList.add('disabled');
          }
          
          daysDiv.appendChild(dayDiv);
        }
        
        monthDiv.appendChild(daysDiv);
        calendar.appendChild(monthDiv);
        
        // ë‹¤ìŒ ë‹¬ë¡œ
        currentDate.setMonth(currentDate.getMonth() + 1);
      }
    }

    function toggleExcludeDate(date, element) {
      const idx = excludedDates.indexOf(date);
      if (idx > -1) {
        excludedDates.splice(idx, 1);
        element.classList.remove('selected');
      } else {
        excludedDates.push(date);
        element.classList.add('selected');
      }
      saveToStorage();
    }

    function renderExcludedDates() {
      const display = document.getElementById('excludedDatesDisplay');
      if (excludedDates.length > 0) {
        display.textContent = `ì œì™¸: ${excludedDates.length}ì¼`;
      } else {
        display.textContent = '';
      }
    }

    // ìŠ¤ì¼€ì¤„ ìƒì„±
    function createSchedule() {
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);
      const selectedBooks = [];
      
      document.querySelectorAll('.book-checkbox:checked').forEach(cb => {
        const idx = parseInt(cb.id.replace('book', ''));
        selectedBooks.push(booksData[idx]);
      });

      if (selectedBooks.length === 0) {
        alert('ì½ì„ ì„±ê²½ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const totalChapters = selectedBooks.reduce((sum, book) => sum + book.chapters, 0);
      const readingDays = getReadingDays(startDate, endDate);
      
      if (readingDays.length === 0) {
        alert('ì½ê¸° ê°€ëŠ¥í•œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // í•˜ë£¨ 1ì¥ì”© ì½ì–´ë„ ê¸°ê°„ë³´ë‹¤ ì¥ìˆ˜ê°€ ì ì€ ê²½ìš°
      if (totalChapters < readingDays.length) {
        const earlyFinish = confirm(`ì„ íƒí•œ ì„±ê²½ì€ ì´ ${totalChapters}ì¥ì´ê³ , ì½ê¸° ê°€ëŠ¥í•œ ë‚ ì€ ${readingDays.length}ì¼ì…ë‹ˆë‹¤.\në§¤ì¼ 1ì¥ì”© ì½ìœ¼ë©´ ${totalChapters}ì¼ì— ì™„ë…ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (!earlyFinish) return;
      }

      const chaptersPerDay = Math.max(1, Math.ceil(totalChapters / readingDays.length));
      const name = prompt('ìŠ¤ì¼€ì¤„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', `${selectedBooks[0].name} ì½ê¸°`);
      
      if (!name) return;

      const schedule = {
        id: Date.now(),
        name,
        startDate: startDate.toISOString().split('T')[0],
        endDate: endDate.toISOString().split('T')[0],
        books: selectedBooks,
        days: readingDays.map((date, idx) => ({
          date,
          chapters: [],
          completed: false
        })),
        createdAt: new Date().toISOString()
      };

      // ì¥ ë°°ë¶„ - ëª¨ë“  ë‚ ì— ê³ ë¥´ê²Œ ë¶„ë°°
      let bookIdx = 0;
      let chapterIdx = 1;
      let totalAssigned = 0;

      for (let dayIdx = 0; dayIdx < schedule.days.length && totalAssigned < totalChapters; dayIdx++) {
        const dayPlan = schedule.days[dayIdx];
        
        // ë‚¨ì€ ì¥ìˆ˜ì™€ ë‚¨ì€ ë‚ ì§œë¥¼ ê³ ë ¤í•˜ì—¬ ì˜¤ëŠ˜ ì½ì„ ì¥ìˆ˜ ê³„ì‚°
        const remainingChapters = totalChapters - totalAssigned;
        const remainingDays = schedule.days.length - dayIdx;
        const chaptersToday = Math.ceil(remainingChapters / remainingDays);
        
        for (let i = 0; i < chaptersToday && totalAssigned < totalChapters; i++) {
          if (bookIdx >= selectedBooks.length) break;
          
          const book = selectedBooks[bookIdx];
          dayPlan.chapters.push({
            book: book.name,
            chapter: chapterIdx,
            read: false
          });
          
          totalAssigned++;
          chapterIdx++;
          
          if (chapterIdx > book.chapters) {
            bookIdx++;
            chapterIdx = 1;
          }
        }
      }

      schedules.push(schedule);
      saveToStorage();
      renderScheduleList();
      alert('ìŠ¤ì¼€ì¤„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function getReadingDays(start, end) {
      const days = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayOfWeek = d.getDay();
        if (selectedDays.includes(dayOfWeek) && !excludedDates.includes(dateStr)) {
          days.push(dateStr);
        }
      }
      return days;
    }

    // ìŠ¤ì¼€ì¤„ ëª©ë¡ ë Œë”ë§
    function renderScheduleList() {
      const list = document.getElementById('scheduleList');
      if (schedules.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div><p>ìƒì„±ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }

      list.innerHTML = schedules.map(schedule => {
        const completed = schedule.days.filter(d => d.completed).length;
        const total = schedule.days.length;
        const progress = (completed / total * 100).toFixed(0);

        return `
          <div class="schedule-card">
            <div class="schedule-header">
              <div class="schedule-name">${schedule.name}</div>
              <div class="schedule-actions">
                <button class="icon-btn" onclick="editSchedule(${schedule.id})">âœï¸</button>
                <button class="icon-btn" onclick="deleteSchedule(${schedule.id})">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div style="font-size: 13px; color: #6c757d; margin-bottom: 5px;">
              ${schedule.startDate} ~ ${schedule.endDate}
            </div>
            <div style="font-size: 13px; color: #6c757d;">
              ì§„í–‰ë¥ : ${completed}/${total}ì¼ (${progress}%)
            </div>
            <div class="schedule-progress">
              <div class="schedule-progress-bar" style="width: ${progress}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function deleteSchedule(id) {
      if (confirm('ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        schedules = schedules.filter(s => s.id !== id);
        saveToStorage();
        renderScheduleList();
      }
    }

    // ìŠ¤ì¼€ì¤„ ì„ íƒê¸°
    function renderScheduleSelector() {
      const selector = document.getElementById('scheduleSelector');
      if (schedules.length === 0) {
        selector.innerHTML = '<div class="empty-state"><p>ìŠ¤ì¼€ì¤„ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”</p></div>';
        return;
      }

      if (schedules.length === 1) {
        currentSchedule = schedules[0];
        selector.innerHTML = '';
      } else {
        selector.innerHTML = `
          <select onchange="selectSchedule(this.value)" style="width: 100%; padding: 10px; border-radius: 10px;">
            ${schedules.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
          </select>
        `;
        currentSchedule = schedules[0];
      }
    }

    function selectSchedule(id) {
      currentSchedule = schedules.find(s => s.id == id);
    }

    // ì„±ê²½ ì½ê¸°
    function loadBookList() {
      const select = document.getElementById('bookSelect');
      if (!currentSchedule) return;

      const books = [...new Set(currentSchedule.books.map(b => b.name))];
      select.innerHTML = books.map(book => `<option value="${book}">${book}</option>`).join('');
      
      // ë§ˆì§€ë§‰ìœ¼ë¡œ ì½ì€ ìœ„ì¹˜ ë¶ˆëŸ¬ì˜¤ê¸°
      const lastRead = localStorage.getItem(`lastRead_${currentSchedule.id}`);
      if (lastRead) {
        const { book, chapter } = JSON.parse(lastRead);
        currentBook = book;
        currentChapter = chapter;
        select.value = book;
      } else if (books.length > 0) {
        currentBook = books[0];
        currentChapter = 1;
      }
      
      loadChapters();
    }

    function loadChapters() {
      const bookName = document.getElementById('bookSelect').value;
      currentBook = bookName;
      const book = booksData.find(b => b.name === bookName);
      
      if (!book) return;

      const select = document.getElementById('chapterSelect');
      select.innerHTML = Array.from({length: book.chapters}, (_, i) => 
        `<option value="${i+1}">${i+1}ì¥</option>`
      ).join('');
      
      select.value = currentChapter;
      loadChapter();
    }

    function loadChapter() {
      currentChapter = parseInt(document.getElementById('chapterSelect').value);
      
      // í˜„ì¬ ìœ„ì¹˜ ì €ì¥
      if (currentSchedule) {
        localStorage.setItem(`lastRead_${currentSchedule.id}`, JSON.stringify({
          book: currentBook,
          chapter: currentChapter
        }));
      }
      
      // ì‹¤ì œ ì„±ê²½ íŒŒì¼ì—ì„œ ë‚´ìš© ë¡œë“œ
      loadBibleText(currentBook, currentChapter);
    }

    // ì„±ê²½ í…ìŠ¤íŠ¸ íŒŒì¼ ë¡œë“œ
    async function loadBibleText(bookName, chapter) {
      const content = document.getElementById('readingContent');
      content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      
      try {
        // ì±… ì •ë³´ ì°¾ê¸°
        const book = booksData.find(b => b.name === bookName);
        if (!book) {
          throw new Error('ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // íŒŒì¼ ê²½ë¡œì—ì„œ í…ìŠ¤íŠ¸ ì½ê¸°
        const response = await fetch(book.file);
        if (!response.ok) {
          throw new Error('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        try {
          const decoder = new TextDecoder('euc-kr');
          text = decoder.decode(buffer);
        } catch (e) {
          // ì‹¤íŒ¨ ì‹œ UTF-8ë¡œ ì‹œë„
          const decoder = new TextDecoder('utf-8');
          text = decoder.decode(buffer);
        }
        
        // í…ìŠ¤íŠ¸ íŒŒì‹±
        const verses = parseBibleText(text, bookName, chapter);
        
        if (verses.length === 0) {
          throw new Error(`${chapter}ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        }
        
        // í™”ë©´ì— ë Œë”ë§
        renderBibleContent(verses);
        
      } catch (error) {
        console.error('ì„±ê²½ ë¡œë“œ ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ
        const sampleVerses = generateSampleVerses(bookName, chapter);
        renderBibleContent(sampleVerses);
        
        // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
        content.innerHTML = `
          <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107;">
            <strong>âš ï¸ ì•ˆë‚´</strong><br>
            <small>ì„±ê²½ í…ìŠ¤íŠ¸ íŒŒì¼(${book?.file || ''})ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
            ì•„ë˜ëŠ” ìƒ˜í”Œ ë°ì´í„°ì…ë‹ˆë‹¤. ì‹¤ì œ ì„±ê²½ íŒŒì¼ì„ bible/ í´ë”ì— ì¶”ê°€í•´ì£¼ì„¸ìš”.</small>
          </div>
        ` + content.innerHTML;
      }
    }

    // ì„±ê²½ í…ìŠ¤íŠ¸ íŒŒì‹±
    function parseBibleText(fileContent, bookName, targetChapter) {
      const lines = fileContent.split('\n');
      const verses = [];
      
      // ì±… ì•½ì–´ ì°¾ê¸°
      const bookData = booksData.find(b => b.name === bookName);
      const bookAbbr = bookData?.abbr || bookName;
      
      for (const line of lines) {
        const trimmedLine = line.trim();
        if (!trimmedLine) continue;
        
        // ì •ê·œì‹: ì°½1:1 <ì œëª©> ë³¸ë¬¸ í˜•ì‹
        // ë˜ëŠ”: ì°½1:1 ë³¸ë¬¸ í˜•ì‹
        const match = trimmedLine.match(/^(\S+?)(\d+):(\d+)\s*(?:<(.+?)>\s*)?(.+)$/);
        
        if (match) {
          const [, book, chapterNum, verseNum, title, text] = match;
          
          // í˜„ì¬ ì¥ì— í•´ë‹¹í•˜ëŠ” êµ¬ì ˆë§Œ ì¶”ì¶œ
          if (parseInt(chapterNum) === targetChapter) {
            verses.push({
              verse: parseInt(verseNum),
              title: title || null,
              text: text.trim()
            });
          }
        }
      }
      
      return verses;
    }

    // ì„±ê²½ ë‚´ìš© ë Œë”ë§
    function renderBibleContent(verses) {
      const content = document.getElementById('readingContent');
      const bookmarkIds = bookmarks.map(b => `${b.book}-${b.chapter}-${b.verse}`);
      
      content.innerHTML = `
        <div class="chapter-content">
          <h3 style="margin-bottom: 20px; color: #333;">${currentBook} ${currentChapter}ì¥</h3>
          ${verses.map(v => `
            <div class="verse">
              <div class="verse-number">${v.verse}</div>
              <div style="flex: 1;">
                ${v.title ? `<div class="verse-title">&lt;${v.title}&gt;</div>` : ''}
                <div class="verse-text">${v.text}</div>
              </div>
              <button class="bookmark-btn ${bookmarkIds.includes(`${currentBook}-${currentChapter}-${v.verse}`) ? 'bookmarked' : ''}" 
                      onclick="toggleBookmark(${v.verse})">
                â­
              </button>
            </div>
          `).join('')}
        </div>
        <div class="read-check">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="readComplete" ${isChapterRead() ? 'checked' : ''} 
                   onchange="markChapterRead(this.checked)">
            <label for="readComplete">ì´ ì¥ì„ ì½ì—ˆìŠµë‹ˆë‹¤</label>
          </div>
        </div>
      `;
    }

    // ìƒ˜í”Œ ì„±ê²½ êµ¬ì ˆ ìƒì„± (íŒŒì¼ì´ ì—†ì„ ë•Œ ì‚¬ìš©)
    function generateSampleVerses(bookName, chapter) {
      const titles = ['ì²œì§€ ì°½ì¡°', 'ë¹›ì˜ ì°½ì¡°', 'ê¶ì°½ì˜ ì°½ì¡°', 'ë•…ê³¼ ë°”ë‹¤', 'í•´ì™€ ë‹¬', 'ìƒë¬¼ì˜ ì°½ì¡°'];
      return Array.from({length: 10}, (_, i) => ({
        verse: i + 1,
        title: i === 0 ? titles[Math.floor(Math.random() * titles.length)] : null,
        text: `${bookName} ${chapter}ì¥ ${i + 1}ì ˆì˜ ìƒ˜í”Œ ë‚´ìš©ì…ë‹ˆë‹¤. ì‹¤ì œë¡œëŠ” ì„±ê²½ í…ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¨ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.`
      }));
    }

    function isChapterRead() {
      if (!currentSchedule) return false;
      
      // í˜„ì¬ ì¥ì´ ì–´ëŠ ë‚ ì§œì— ì½ì„ ê³„íšì¸ì§€ ì°¾ê¸°
      for (const day of currentSchedule.days) {
        const chapter = day.chapters.find(
          ch => ch.book === currentBook && ch.chapter === currentChapter
        );
        if (chapter) {
          return chapter.read || false;
        }
      }
      return false;
    }

    // ì´ì „ ì¥ìœ¼ë¡œ ì´ë™
    function prevChapter() {
      const book = booksData.find(b => b.name === currentBook);
      if (!book) return;

      if (currentChapter > 1) {
        currentChapter--;
        document.getElementById('chapterSelect').value = currentChapter;
        loadChapter();
      } else {
        // ì´ì „ ì±…ì˜ ë§ˆì§€ë§‰ ì¥ìœ¼ë¡œ
        const currentBookIdx = booksData.findIndex(b => b.name === currentBook);
        if (currentBookIdx > 0) {
          const prevBook = booksData[currentBookIdx - 1];
          
          // ìŠ¤ì¼€ì¤„ì— í¬í•¨ëœ ì±…ì¸ì§€ í™•ì¸
          if (currentSchedule && !currentSchedule.books.some(b => b.name === prevBook.name)) {
            alert('ì´ì „ ì±…ì€ í˜„ì¬ ìŠ¤ì¼€ì¤„ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
          }
          
          currentBook = prevBook.name;
          currentChapter = prevBook.chapters;
          
          document.getElementById('bookSelect').value = currentBook;
          loadChapters();
        } else {
          alert('ì²« ë²ˆì§¸ ì¥ì…ë‹ˆë‹¤.');
        }
      }
    }

    // ë‹¤ìŒ ì¥ìœ¼ë¡œ ì´ë™
    function nextChapter() {
      const book = booksData.find(b => b.name === currentBook);
      if (!book) return;

      if (currentChapter < book.chapters) {
        currentChapter++;
        document.getElementById('chapterSelect').value = currentChapter;
        loadChapter();
      } else {
        // ë‹¤ìŒ ì±…ì˜ ì²« ì¥ìœ¼ë¡œ
        const currentBookIdx = booksData.findIndex(b => b.name === currentBook);
        if (currentBookIdx < booksData.length - 1) {
          const nextBook = booksData[currentBookIdx + 1];
          
          // ìŠ¤ì¼€ì¤„ì— í¬í•¨ëœ ì±…ì¸ì§€ í™•ì¸
          if (currentSchedule && !currentSchedule.books.some(b => b.name === nextBook.name)) {
            alert('ë‹¤ìŒ ì±…ì€ í˜„ì¬ ìŠ¤ì¼€ì¤„ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
          }
          
          currentBook = nextBook.name;
          currentChapter = 1;
          
          document.getElementById('bookSelect').value = currentBook;
          loadChapters();
        } else {
          alert('ë§ˆì§€ë§‰ ì¥ì…ë‹ˆë‹¤.');
        }
      }
    }

    // ì§„í–‰ìƒí™© ìŠ¤ì¼€ì¤„ ì„ íƒê¸°
    function renderProgressScheduleSelector() {
      const selector = document.getElementById('progressScheduleSelector');
      if (schedules.length === 0) {
        selector.innerHTML = '<div class="empty-state"><p>ìŠ¤ì¼€ì¤„ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”</p></div>';
        return;
      }

      if (schedules.length === 1) {
        currentSchedule = schedules[0];
        selector.innerHTML = `<h3>${currentSchedule.name}</h3>`;
      } else {
        selector.innerHTML = `
          <select onchange="selectProgressSchedule(this.value)" style="width: 100%; padding: 10px; border-radius: 10px;">
            ${schedules.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
          </select>
        `;
        currentSchedule = schedules[0];
      }
    }

    function selectProgressSchedule(id) {
      currentSchedule = schedules.find(s => s.id == id);
      renderProgressCalendar();
    }

    // ì§„í–‰ìƒí™© ë‹¬ë ¥ ë Œë”ë§
    function renderProgressCalendar() {
      const container = document.getElementById('progressCalendar');
      if (!currentSchedule) {
        container.innerHTML = '<div class="empty-state"><p>ìŠ¤ì¼€ì¤„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p></div>';
        return;
      }

      const today = new Date().toISOString().split('T')[0];

      container.innerHTML = currentSchedule.days.map(day => {
        const dayDate = new Date(day.date);
        const isToday = day.date === today;
        const isPast = day.date < today;
        const isFuture = day.date > today;
        
        let statusClass = 'upcoming';
        let statusText = 'ì˜ˆì •';
        
        if (isPast || isToday) {
          if (day.completed) {
            statusClass = 'completed';
            statusText = 'ì™„ë£Œ';
          } else {
            statusClass = 'missed';
            statusText = 'ë¯¸ì™„ë£Œ';
          }
        }

        const chaptersText = day.chapters.map(ch => {
          const readMark = ch.read ? 'âœ“ ' : '';
          return `${readMark}${ch.book} ${ch.chapter}ì¥`;
        }).join(', ');

        const dateText = `${dayDate.getMonth() + 1}ì›” ${dayDate.getDate()}ì¼ (${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dayDate.getDay()]})`;

        return `
          <div class="progress-day ${statusClass}">
            <div class="progress-day-header">
              <div class="progress-date">${dateText}</div>
              <div class="progress-status ${statusClass}">${statusText}</div>
            </div>
            <div class="progress-chapters">${chaptersText}</div>
          </div>
        `;
      }).join('');
    }

    function markChapterRead(checked) {
      if (!currentSchedule) return;
      
      const today = new Date().toISOString().split('T')[0];
      
      // í˜„ì¬ ì½ê³  ìˆëŠ” ì¥ì´ ì˜¤ëŠ˜ ì¼ì •ì— ìˆëŠ”ì§€ í™•ì¸
      const todayPlan = currentSchedule.days.find(d => {
        return d.chapters.some(ch => ch.book === currentBook && ch.chapter === currentChapter);
      });
      
      if (todayPlan) {
        // í•´ë‹¹ ì¥ì„ ì½ìŒ ì²˜ë¦¬
        const chapterIndex = todayPlan.chapters.findIndex(
          ch => ch.book === currentBook && ch.chapter === currentChapter
        );
        
        if (chapterIndex > -1) {
          todayPlan.chapters[chapterIndex].read = checked;
        }
        
        // ëª¨ë“  ì¥ì„ ì½ì—ˆëŠ”ì§€ í™•ì¸
        const allRead = todayPlan.chapters.every(ch => ch.read);
        todayPlan.completed = allRead;
        
        saveToStorage();
        renderScheduleList();
        
        // ì½ìŒ í‘œì‹œë¥¼ í•˜ë©´ ë‹¤ìŒ ì¥ìœ¼ë¡œ ìë™ ì´ë™
        if (checked) {
          setTimeout(() => {
            nextChapter();
          }, 500);
        }
      }
    }

    function toggleBookmark(verse) {
      const id = `${currentBook}-${currentChapter}-${verse}`;
      const idx = bookmarks.findIndex(b => `${b.book}-${b.chapter}-${b.verse}` === id);
      
      if (idx > -1) {
        bookmarks.splice(idx, 1);
      } else {
        bookmarks.push({
          book: currentBook,
          chapter: currentChapter,
          verse,
          schedule: currentSchedule?.name || 'ì—†ìŒ',
          date: new Date().toISOString().split('T')[0]
        });
      }
      
      saveToStorage();
      loadChapter();
    }

    function renderBookmarks() {
      const list = document.getElementById('bookmarkList');
      
      if (bookmarks.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â­</div><p>ì €ì¥ëœ ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }

      list.innerHTML = bookmarks.map((bm, idx) => `
        <div class="schedule-card">
          <div style="font-weight: 600; margin-bottom: 8px;">${bm.book} ${bm.chapter}:${bm.verse}</div>
          <div style="font-size: 13px; color: #6c757d; margin-bottom: 5px;">ìŠ¤ì¼€ì¤„: ${bm.schedule}</div>
          <div style="font-size: 13px; color: #6c757d;">ë‚ ì§œ: ${bm.date}</div>
          <button class="icon-btn" style="margin-top: 10px;" onclick="removeBookmark(${idx})">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    function removeBookmark(idx) {
      bookmarks.splice(idx, 1);
      saveToStorage();
      renderBookmarks();
    }

    // ìë™ ìŠ¤ì¼€ì¤„ ì¬í¸ì„±
    function rescheduleRemaining() {
      if (!currentSchedule) return;
      
      const today = new Date().toISOString().split('T')[0];
      const todayIdx = currentSchedule.days.findIndex(d => d.date === today);
      
      if (todayIdx === -1) return;

      // ì˜¤ëŠ˜ê¹Œì§€ ì½ì§€ ì•Šì€ ì¥ë“¤ ìˆ˜ì§‘
      const unreadChapters = [];
      for (let i = 0; i <= todayIdx; i++) {
        const day = currentSchedule.days[i];
        if (!day.completed) {
          unreadChapters.push(...day.chapters);
        }
      }

      // ë‚¨ì€ ë‚ ì§œì— ì¬ë°°ë¶„
      const remainingDays = currentSchedule.days.slice(todayIdx + 1);
      if (remainingDays.length === 0) return;

      const chaptersPerDay = Math.ceil(unreadChapters.length / remainingDays.length);
      let chapterIdx = 0;

      remainingDays.forEach(day => {
        const additionalChapters = unreadChapters.slice(chapterIdx, chapterIdx + chaptersPerDay);
        day.chapters = [...day.chapters, ...additionalChapters];
        chapterIdx += chaptersPerDay;
      });

      saveToStorage();
    }

    // ìì • ì²´í¬
    function checkMidnightReschedule() {
      const lastCheck = localStorage.getItem('lastMidnightCheck');
      const today = new Date().toISOString().split('T')[0];
      
      if (lastCheck !== today) {
        schedules.forEach(schedule => {
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().split('T')[0];
          
          const yesterdayPlan = schedule.days.find(d => d.date === yesterdayStr);
          if (yesterdayPlan && !yesterdayPlan.completed) {
            rescheduleFromYesterday(schedule, yesterdayStr);
          }
        });
        
        localStorage.setItem('lastMidnightCheck', today);
        saveToStorage();
      }

      // ë‹¤ìŒ ìì •ê¹Œì§€ ëŒ€ê¸°
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(0, 0, 0, 0);
      const timeUntilMidnight = tomorrow - now;
      
      setTimeout(() => {
        checkMidnightReschedule();
      }, timeUntilMidnight);
    }

    function rescheduleFromYesterday(schedule, yesterday) {
      const yesterdayIdx = schedule.days.findIndex(d => d.date === yesterday);
      if (yesterdayIdx === -1) return;

      const unreadChapters = schedule.days[yesterdayIdx].chapters;
      const remainingDays = schedule.days.slice(yesterdayIdx + 1);
      
      if (remainingDays.length === 0) return;

      const chaptersPerDay = Math.ceil(unreadChapters.length / remainingDays.length);
      let chapterIdx = 0;

      remainingDays.forEach(day => {
        const additionalChapters = unreadChapters.slice(chapterIdx, chapterIdx + chaptersPerDay);
        day.chapters = [...day.chapters, ...additionalChapters];
        chapterIdx += chaptersPerDay;
      });
    }

    function editSchedule(id) {
      const schedule = schedules.find(s => s.id === id);
      if (!schedule) return;
      
      alert('ìŠ¤ì¼€ì¤„ í¸ì§‘ ê¸°ëŠ¥ì€ ê° ë‚ ì§œì˜ ì½ìŒ í‘œì‹œë¥¼ í†µí•´ ì§„í–‰ ìƒí™©ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    init();
  </script>
</body>
</html>
